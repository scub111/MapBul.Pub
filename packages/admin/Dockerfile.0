FROM node:alpine as build

ARG npm_token
ENV NPM_TOKEN=${npm_token}

WORKDIR /app
COPY .eslintrc.js .
COPY .npmrc .
COPY package.json .
COPY package-lock.json .
COPY stylus.d.ts stylus.d.ts
COPY window.d.ts window.d.ts
COPY nginx.conf nginx.conf
COPY tsconfig.json tsconfig.json
COPY src src
COPY public public
COPY config config
COPY scripts scripts
RUN echo -e "\n//artifacts.vostokservices.com/repository/npm/:_authToken=NpmToken.${NPM_TOKEN}" >> ".npmrc"
RUN cat .npmrc
RUN npm ci 
RUN npm run build

FROM nginx:alpine AS production

WORKDIR /app
COPY --from=build /app/nginx.conf /etc/nginx/nginx.conf
COPY --from=build /app/build /usr/share/nginx/html

EXPOSE 8888
